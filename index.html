<!DOCTYPE html>
<html lang="vi">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta charset="UTF-8">
<title>LÃªn lá»‹ch trá»±c nháº­t lá»›p</title>

<style>
:root{
  --bg:#eef2ff;
  --card:#ffffff;
  --primary:#4f46e5;
  --secondary:#06b6d4;
  --accent:#22c55e;
  --danger:#ef4444;
  --text:#1f2937;
  --muted:#6b7280;
  --page-bg: linear-gradient(135deg,var(--bg),#c7d2fe);
}
/* ===== THEMES (mÃ u chá»§ Ä‘áº¡o) ===== */
/* ===== THEMES (mÃ u + ná»n) ===== */
body.theme-indigo{
  --primary:#4f46e5; --secondary:#06b6d4;
  --page-bg: linear-gradient(135deg,#eef2ff,#c7d2fe);
}
body.theme-emerald{
  --primary:#10b981; --secondary:#22c55e;
  --page-bg: linear-gradient(135deg,#ecfdf5,#bbf7d0);
}
body.theme-rose{
  --primary:#f43f5e; --secondary:#fb7185;
  --page-bg: linear-gradient(135deg,#fff1f2,#fecdd3);
}
body.theme-amber{
  --primary:#f59e0b; --secondary:#f97316;
  --page-bg: linear-gradient(135deg,#fffbeb,#fed7aa);
}
body.theme-slate{
  --primary:#334155; --secondary:#64748b;
  --page-bg: linear-gradient(135deg,#f1f5f9,#cbd5e1);
}

body.dark{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#9ca3af;  
  --page-bg: linear-gradient(135deg,#0f172a,#1e293b);
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:20px;
  font-family:Segoe UI,Arial;
  background:var(--page-bg);
  color:var(--text);
  transition:.3s;
}

h1{text-align:center;margin-bottom:10px}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  max-width:1200px;
  margin:auto;
}

button{
  border:none;
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
  font-weight:500;
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:white;
}

button.secondary{
  background:linear-gradient(135deg,#64748b,#94a3b8);
}

button.green{
  background:linear-gradient(135deg,#22c55e,#4ade80);
}

button.red{
  background:linear-gradient(135deg,#ef4444,#f87171);
}

button.small{
  padding:4px 8px;
  font-size:12px;
}

.container{
  max-width:1200px;
  margin:auto;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:16px;
}

.card{
  background:var(--card);
  border-radius:16px;
  padding:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}

.card h3{
  margin-top:0;
  color:var(--primary);
}

/* Chá»‰ Ã¡p dá»¥ng full width cho input dáº¡ng nháº­p liá»‡u, KHÃ”NG Ã¡p cho checkbox */
textarea,
select,
input[type="date"],
input[type="number"],
input[type="text"]{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #c7d2fe;
  background:transparent;
  color:var(--text);
}
/* LÃ m Ã´ danh sÃ¡ch há»c sinh cao hÆ¡n */
#studentsInput{
  min-height: 220px;   /* báº¡n tÄƒng/giáº£m tÃ¹y Ã½: 180â€“320px */
  resize: vertical;    /* cho phÃ©p kÃ©o cao/tháº¥p */
  line-height: 1.4;
}
/* Checkbox: Ä‘á»ƒ auto + canh Ä‘áº¹p */
input[type="checkbox"]{
  width:auto;
  padding:0;
  margin:0;
}

/* LÆ°á»›i ngÃ y trong tuáº§n gá»n & khÃ´ng lá»‡ch */
.weekdays{
  display:grid;
  grid-template-columns:repeat(2, minmax(0,1fr));
  gap:8px 12px;
  margin-bottom:10px;
}

.weekdays label{
  display:flex;
  align-items:center;
  gap:8px;
  margin:0;
  user-select:none;
}

.error{
  text-align:center;
  color:var(--danger);
  font-weight:bold;
  margin-bottom:10px;
}

/* TABLE */
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  border-radius:14px;
  overflow:hidden;
}

th{
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:white;
  padding:10px;
}

td{
  padding:8px;
  border-bottom:1px solid #334155;
  background:var(--card);
  text-align:center;
}

tr.thursday td{
  background:rgba(34,197,94,.15);
}

select{margin:2px 0}

select.locked{
  opacity:.6;
  pointer-events:none;
}

/* PRINT */
@media print{
  button,textarea,input,.weekdays,.topbar{display:none}
  body{background:white}
  .card{box-shadow:none}
}
  /* ===== MOBILE SCALE FIX ===== */
@media (max-width: 768px){
  body{
    padding: 12px;
    font-size: 16px;            /* tÄƒng chá»¯ tá»•ng */
  }

  .container{
    grid-template-columns: 1fr; /* xáº¿p 1 cá»™t cho dá»… nhÃ¬n */
    gap: 12px;
  }

  h1{
    font-size: 20px;
  }

  .card{
    padding: 14px;
    border-radius: 16px;
  }

  button{
    padding: 12px 14px;         /* nÃºt bá»± hÆ¡n, dá»… báº¥m */
    border-radius: 14px;
    font-size: 15px;
  }

  textarea,
  select,
  input[type="date"],
  input[type="number"],
  input[type="text"]{
    padding: 12px;
    font-size: 16px;            /* iOS: >=16px Ä‘á»ƒ trÃ¡nh tá»± zoom */
    border-radius: 12px;
  }

  /* báº£ng Ä‘á»¡ cháº­t */
  th, td{
    padding: 10px 8px;
    font-size: 14px;
  }

  /* iOS: dropdown bÃ© -> tÄƒng min-height */
  select{
    min-height: 44px;
  }

  /* vÃ¹ng Ä‘á»•i tÃªn + khÃ³a trong cell: cho thoÃ¡ng */
  .cellRow{
    gap: 8px;
  }
}
</style>
</head>

<body class="theme-indigo">

<div class="topbar">
  <h1>ğŸ“… LÃªn lá»‹ch trá»±c nháº­t lá»›p</h1>

  <div style="display:flex; gap:10px; align-items:center;">
    <select id="themeSelect" style="width:160px;">
      <option value="theme-indigo">Indigo (máº·c Ä‘á»‹nh)</option>
      <option value="theme-emerald">Emerald</option>
      <option value="theme-rose">Rose</option>
      <option value="theme-amber">Amber</option>
      <option value="theme-slate">Slate</option>
    </select>
    <button class="secondary" onclick="toggleDark()">ğŸŒ™ / â˜€</button>
  </div>
</div>


<div id="error" class="error"></div>

<div class="container">

  <div class="card">
    <h3>ğŸ‘©â€ğŸ“ Danh sÃ¡ch há»c sinh</h3>
    <textarea id="studentsInput" placeholder="Má»—i dÃ²ng 1 tÃªn..."></textarea>
    <button onclick="cleanStudents()">LÃ m sáº¡ch</button>
    <button class="secondary" onclick="shuffleStudents()">Shuffle</button>
    <small>Sá»‘ HS: <b id="studentCount">0</b></small>
  </div>

  <div class="card">
    <h3>ğŸ“† Thá»i gian</h3>
   <div style="display:grid; gap:8px;">
  <div>
    <input type="date" id="startDate">
    <small style="color:var(--muted)">Hiá»ƒn thá»‹: <b id="startDateDMY">--/--/----</b></small>
  </div>
  <div>
    <input type="date" id="endDate">
    <small style="color:var(--muted)">Hiá»ƒn thá»‹: <b id="endDateDMY">--/--/----</b></small>
  </div>
</div>
  </div>

  <div class="card">
    <h3>ğŸ“Œ Lá»c ngÃ y</h3>
    <div class="weekdays">
      <label><input type="checkbox" class="weekday" value="1" checked> T2</label>
      <label><input type="checkbox" class="weekday" value="2" checked> T3</label>
      <label><input type="checkbox" class="weekday" value="3" checked> T4</label>
      <label><input type="checkbox" class="weekday" value="4" checked> T5</label>
      <label><input type="checkbox" class="weekday" value="5" checked> T6</label>
      <label><input type="checkbox" class="weekday" value="6"> T7</label>
      <label><input type="checkbox" class="weekday" value="0"> CN</label>
    </div>
    <textarea id="exceptionsInput" placeholder="NgÃ y nghá»‰ (má»—i dÃ²ng 1 ngÃ y): dd/mm/yyyy hoáº·c yyyy-mm-dd"></textarea>
  </div>


  <div class="card">
    <h3>âš™ï¸ Äiá»u khiá»ƒn</h3>
    <input type="number" id="startIndex" min="0" value="0">
    <button class="green" onclick="generate()">âœ¨ Táº¡o lá»‹ch</button>
    <div style="display:grid; grid-template-columns: 1fr auto auto; gap:10px; margin:10px 0;">
  <select id="profileSelect"></select>
  <button class="secondary" onclick="createProfile()">â•</button>
  <button class="red" onclick="deleteProfile()">ğŸ—‘</button>
</div>
    <button onclick="saveConfig()">ğŸ’¾ LÆ°u</button>
    <button onclick="loadConfig()">ğŸ“‚ Táº£i</button>
    <button onclick="exportPNG()">ğŸ“· PNG</button>
    <button onclick="exportCSV()">ğŸ“¤ CSV</button>
    <button class="secondary" onclick="window.print()">ğŸ–¨ In</button>
    <button id="btnUndo" class="secondary" onclick="undo()">â†© Undo</button>
    <button id="btnRedo" class="secondary" onclick="redo()">â†ª Redo</button>


  </div>

</div>

<div class="card" style="margin-top:20px">
  <h3>ğŸ“‹ Báº£ng phÃ¢n cÃ´ng</h3>
  <div style="display:grid; grid-template-columns: 1fr 180px 110px; gap:10px; margin:10px 0;">
  <input id="searchName" type="text" placeholder="TÃ¬m theo tÃªn...">
  <input id="searchDate" type="date">
  <button class="secondary" onclick="clearSearch()">XÃ³a lá»c</button>
</div>
  <div id="schedule"></div>
</div>

<div class="card" style="margin-top:20px">
  <h3>ğŸ“Š Thá»‘ng kÃª sá»‘ ca trá»±c</h3>
  <div id="stats"></div>
</div>

<script>
let state={students:[],schedule:[],locked:{}};
function formatDMY(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}
// ===== UNDO / REDO =====
let history = [];
let historyIndex = -1;

function snapshotState(){
  // Chá»‰ snapshot nhá»¯ng thá»© cáº§n undo/redo
  return {
    students: [...state.students],
    schedule: JSON.parse(JSON.stringify(state.schedule)),
    locked: JSON.parse(JSON.stringify(state.locked)),
    // giá»¯ filter náº¿u báº¡n muá»‘n undo theo filter, cÃ²n khÃ´ng thÃ¬ bá»
  };
}

function applySnapshot(snap){
  state.students = [...snap.students];
  // Phá»¥c há»“i Date object
  state.schedule = snap.schedule.map(r => ({
    date: new Date(r.date),
    morning: [...(r.morning || [])],
    afternoon: [...(r.afternoon || [])]
  }));
  state.locked = {...(snap.locked || {})};
  render();
}

function pushHistory(){
  const snap = snapshotState();

  // Náº¿u Ä‘ang á»Ÿ giá»¯a history mÃ  cÃ³ thay Ä‘á»•i má»›i => cáº¯t nhÃ¡nh redo
  if (historyIndex < history.length - 1) {
    history = history.slice(0, historyIndex + 1);
  }

  history.push(snap);
  historyIndex = history.length - 1;

  updateUndoRedoUI();
}

function undo(){
  if (historyIndex <= 0) return;
  historyIndex--;
  applySnapshot(history[historyIndex]);
  updateUndoRedoUI();
}

function redo(){
  if (historyIndex >= history.length - 1) return;
  historyIndex++;
  applySnapshot(history[historyIndex]);
  updateUndoRedoUI();
}

function updateUndoRedoUI(){
  const u = document.getElementById("btnUndo");
  const r = document.getElementById("btnRedo");
  if (u) u.disabled = !(historyIndex > 0);
  if (r) r.disabled = !(historyIndex < history.length - 1);
}

// PhÃ­m táº¯t Ctrl+Z / Ctrl+Y / Ctrl+Shift+Z
document.addEventListener("keydown", (e) => {
  const isMac = navigator.platform.toUpperCase().includes("MAC");
  const ctrl = isMac ? e.metaKey : e.ctrlKey;

  if (!ctrl) return;

  // Náº¿u Ä‘ang gÃµ trong input/textarea/select thÃ¬ váº«n cho undo/redo lá»‹ch (tuá»³ báº¡n)
  if (e.key.toLowerCase() === "z") {
    e.preventDefault();
    if (e.shiftKey) redo();
    else undo();
  }
  if (e.key.toLowerCase() === "y") {
    e.preventDefault();
    redo();
  }
});
// ===== THEME SWITCHER =====
const THEME_KEY = "theme_class";
const THEMES = ["theme-indigo","theme-emerald","theme-rose","theme-amber","theme-slate"];

function applyTheme(themeClass){
  // gá»¡ theme cÅ©
  THEMES.forEach(t => document.body.classList.remove(t));
  // set theme má»›i
  if (THEMES.includes(themeClass)) {
    document.body.classList.add(themeClass);
    localStorage.setItem(THEME_KEY, themeClass);
  } else {
    // fallback
    document.body.classList.add("theme-indigo");
    localStorage.setItem(THEME_KEY, "theme-indigo");
  }
}

function initTheme(){
  const saved = localStorage.getItem(THEME_KEY) || "theme-indigo";
  applyTheme(saved);

  const sel = document.getElementById("themeSelect");
  if(sel){
    sel.value = saved;
    sel.addEventListener("change", () => applyTheme(sel.value));
  }
}


function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("dark",document.body.classList.contains("dark"));
}
if(localStorage.getItem("dark")==="true") document.body.classList.add("dark");

function showError(m){error.innerText=m||""}

function cleanStudents(){
  const a=studentsInput.value.split("\n").map(s=>s.trim()).filter(Boolean);
  studentsInput.value=a.join("\n");
  studentCount.innerText=a.length;
}

function shuffleStudents(){
  cleanStudents();
  let a=studentsInput.value.split("\n");
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  studentsInput.value=a.join("\n");
}

function getValidDates(s,e,w,ex){
  let d=new Date(s),r=[];
  while(d<=e){
    const iso=d.toISOString().slice(0,10);
    if(w.includes(d.getDay())&&!ex.includes(iso)) r.push(new Date(d));
    d.setDate(d.getDate()+1);
  }
  return r;
}

function generateScheduleRoundRobin(stu,dates,start){
  let i=start,n=stu.length,res=[];
  dates.forEach(d=>{
    if(d.getDay()===4){
      res.push({date:d,morning:[],afternoon:[stu[i%n],stu[(i+1)%n]]});
      i=(i+2)%n;
    }else{
      const p=[stu[i%n],stu[(i+1)%n],stu[(i+2)%n],stu[(i+3)%n]];
      res.push({date:d,morning:p.slice(0,2),afternoon:p.slice(2)});
      i=(i+4)%n;
    }
  });
  return res;
}

function generate(){
  showError("");
  cleanStudents();
  const stu=studentsInput.value.split("\n");
  if(stu.length<4) return showError("KhÃ´ng Ä‘á»§ há»c sinh");
  const s=new Date(startDate.value),e=new Date(endDate.value);
  if(isNaN(s)||isNaN(e)||s>e) return showError("NgÃ y khÃ´ng há»£p lá»‡");
  const w=[...document.querySelectorAll(".weekday:checked")].map(c=>+c.value);
  const ex = exceptionsInput.value
  .split("\n")
  .map(s=>s.trim())
  .filter(Boolean)
  .map(s=>{
    // náº¿u dd/mm/yyyy -> Ä‘á»•i sang yyyy-mm-dd Ä‘á»ƒ so sÃ¡nh
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
      const [dd,mm,yyyy] = s.split("/").map(Number);
      return `${yyyy}-${String(mm).padStart(2,"0")}-${String(dd).padStart(2,"0")}`;
    }
    return s; // giá»¯ nguyÃªn náº¿u Ä‘Ã£ lÃ  yyyy-mm-dd
  });
  state.students=stu;
  state.schedule=generateScheduleRoundRobin(stu,getValidDates(s,e,w,ex),+startIndex.value||0);
  state.locked={};
  render();
  pushHistory();
}

function render(){
  renderTable();
  renderStats();
}
function clearSearch(){
  const n = document.getElementById("searchName");
  const d = document.getElementById("searchDate");
  if(n) n.value = "";
  if(d) d.value = "";
  renderTable();
}
function swapDay(rowIndex){
  const r = state.schedule[rowIndex];
  if(!r) return;

  // Thá»© 5 báº¡n Ä‘ang cÃ³ luáº­t: chá»‰ cÃ³ ca chiá»u 2 báº¡n -> khÃ´ng cho Ä‘áº£o
  if(r.date.getDay() === 4){
    alert("Thá»© 5 chá»‰ trá»±c ca chiá»u nÃªn khÃ´ng thá»ƒ Ä‘áº£o ca.");
    return;
  }

  const tmp = r.morning;
  r.morning = r.afternoon;
  r.afternoon = tmp;

  render(); // cáº­p nháº­t báº£ng + thá»‘ng kÃª

  // náº¿u báº¡n cÃ³ Undo/Redo
  if(typeof pushHistory === "function") pushHistory();
}
function renderTable(){
  if(!state.schedule.length){schedule.innerHTML="";return;}

  const nameQ = (document.getElementById("searchName")?.value || "").trim().toLowerCase();
  const dateQ = (document.getElementById("searchDate")?.value || "").trim(); // YYYY-MM-DD

  const rows = state.schedule.filter(r=>{
  const iso = r.date.toISOString().slice(0,10); // YYYY-MM-DD Ä‘á»ƒ so vá»›i input type="date"
  if(dateQ && iso !== dateQ) return false;

  if(nameQ){
    const all = [...(r.morning||[]), ...(r.afternoon||[])].join(" ").toLowerCase();
    if(!all.includes(nameQ)) return false;
  }

  return true;
});


  let h=`<table><tr><th>NgÃ y</th><th>Thá»©</th><th>Ca sÃ¡ng</th><th>Ca chiá»u</th></tr>`;
  rows.forEach((r)=>{
    const i = state.schedule.indexOf(r); // láº¥y index gá»‘c Ä‘á»ƒ cell() sá»­a Ä‘Ãºng
    const w=["CN","T2","T3","T4","T5","T6","T7"][r.date.getDay()];
    h+=`<tr class="${r.date.getDay()===4?"thursday":""}" ondblclick="swapDay(${i})" title="Double-click Ä‘á»ƒ Ä‘áº£o ca (khÃ´ng Ã¡p dá»¥ng T5)">
  <td>${formatDMY(r.date)}</td>
  <td>${w}</td>
  <td>${cell(r.morning,i,"morning")}</td>
  <td>${cell(r.afternoon,i,"afternoon")}</td>
</tr>`;
  });

  schedule.innerHTML=h+"</table>";
}


function cell(arr,r,t){
  if(!arr.length) return "â€”";
  return arr.map((n,i)=>{
    const key = `${r}-${t}-${i}`;
    const isLocked = !!state.locked[key];

    return `
      <div style="display:flex; gap:6px; align-items:center; justify-content:center; margin:2px 0;">
        <select class="${isLocked ? "locked" : ""}"
        onchange="state.schedule[${r}].${t}[${i}]=this.value;renderStats();pushHistory();">
          ${state.students.map(s=>`<option ${s===n?"selected":""}>${s}</option>`).join("")}
        </select>
        <button class="small secondary" onclick="lock('${key}')">${isLocked ? "ğŸ”“" : "ğŸ”’"}</button>
      </div>
    `;
  }).join("");
}

function lock(k){
  state.locked[k]=!state.locked[k];
  renderTable();
  pushHistory();
}

function renderStats(){
  let c={};
  state.students.forEach(s=>c[s]=0);
  state.schedule.forEach(r=>{
    [...r.morning,...r.afternoon].forEach(s=>c[s]++);
  });
  stats.innerHTML=Object.entries(c)
    .sort((a,b)=>b[1]-a[1])
    .map(([n,v])=>`${n}: <b>${v}</b> ca`)
    .join("<br>");
}

// ===== PROFILES =====
const PROFILES_KEY = "profiles_index";
const ACTIVE_PROFILE_KEY = "profiles_active";

function getProfiles(){
  try{
    return JSON.parse(localStorage.getItem(PROFILES_KEY) || "[]");
  }catch{ return []; }
}

function setProfiles(arr){
  localStorage.setItem(PROFILES_KEY, JSON.stringify(arr));
}

function getActiveProfile(){
  return localStorage.getItem(ACTIVE_PROFILE_KEY) || "";
}

function setActiveProfile(id){
  localStorage.setItem(ACTIVE_PROFILE_KEY, id);
}

function profileKey(id){
  return `cfg_${id}`;
}

function refreshProfileSelect(){
  const sel = document.getElementById("profileSelect");
  if(!sel) return;

  const profiles = getProfiles();
  sel.innerHTML = profiles.map(p => `<option value="${p.id}">${p.name}</option>`).join("");

  const active = getActiveProfile();
  if(active && profiles.some(p=>p.id===active)) sel.value = active;
  else if(profiles[0]) { sel.value = profiles[0].id; setActiveProfile(profiles[0].id); }

  sel.onchange = () => {
    setActiveProfile(sel.value);
  };
}

function initProfiles(){
  let profiles = getProfiles();
  if(!profiles.length){
    profiles = [{id:"default", name:"Máº·c Ä‘á»‹nh"}];
    setProfiles(profiles);
    setActiveProfile("default");
  }
  refreshProfileSelect();
}

function createProfile(){
  const name = prompt("TÃªn profile (vd: Lá»›p 5A):");
  if(!name) return;

  const id = "p_" + Date.now();
  const profiles = getProfiles();
  profiles.push({id, name: name.trim()});
  setProfiles(profiles);
  setActiveProfile(id);
  refreshProfileSelect();
  alert("âœ… ÄÃ£ táº¡o profile. Báº¡n cÃ³ thá»ƒ báº¥m LÆ°u Ä‘á»ƒ lÆ°u cáº¥u hÃ¬nh vÃ o profile nÃ y.");
}

function deleteProfile(){
  const profiles = getProfiles();
  const sel = document.getElementById("profileSelect");
  if(!sel) return;
  const id = sel.value;

  if(id === "default"){
    alert("KhÃ´ng xÃ³a Ä‘Æ°á»£c profile Máº·c Ä‘á»‹nh.");
    return;
  }
  if(!confirm("XÃ³a profile nÃ y? Dá»¯ liá»‡u Ä‘Ã£ lÆ°u sáº½ máº¥t.")) return;

  const next = profiles.filter(p=>p.id !== id);
  setProfiles(next);
  localStorage.removeItem(profileKey(id));

  setActiveProfile(next[0]?.id || "default");
  refreshProfileSelect();
}

// ===== SAVE/LOAD theo profile =====
function saveConfig(){
  try{
    const id = getActiveProfile() || "default";
    localStorage.setItem(profileKey(id), JSON.stringify({
      s:studentsInput.value,
      sd:startDate.value,
      ed:endDate.value,
      w:[...document.querySelectorAll(".weekday")].map(c=>c.checked),
      ex:exceptionsInput.value,
      i:startIndex.value,
      dark:document.body.classList.contains("dark")
    }));
    alert("âœ… ÄÃ£ lÆ°u vÃ o profile: " + (document.getElementById("profileSelect")?.selectedOptions?.[0]?.text || id));
  }catch(e){
    console.error(e);
    showError("âŒ KhÃ´ng thá»ƒ lÆ°u (cÃ³ thá»ƒ bá»‹ cháº·n localStorage).");
  }
}

function loadConfig(){
  try{
    const id = getActiveProfile() || "default";
    const raw = localStorage.getItem(profileKey(id));
    if(!raw){
      alert("âš ï¸ Profile nÃ y chÆ°a cÃ³ dá»¯ liá»‡u. HÃ£y báº¥m LÆ°u trÆ°á»›c.");
      return;
    }
    const d = JSON.parse(raw);

    studentsInput.value=d.s||"";
    startDate.value=d.sd||"";
    endDate.value=d.ed||"";
    exceptionsInput.value=d.ex||"";
    startIndex.value=d.i ?? 0;

    document.querySelectorAll(".weekday").forEach((c,i)=>{
      if(Array.isArray(d.w) && i<d.w.length) c.checked=!!d.w[i];
    });

    document.body.classList.toggle("dark", !!d.dark);
    cleanStudents();

    alert("ğŸ“‚ ÄÃ£ táº£i tá»« profile.");
  }catch(e){
    console.error(e);
    showError("âŒ KhÃ´ng thá»ƒ táº£i (dá»¯ liá»‡u lá»—i hoáº·c bá»‹ cháº·n localStorage).");
  }
}
function exportPNG(){
  const table = document.querySelector("#schedule table");
  if(!table){
    alert("ChÆ°a cÃ³ báº£ng Ä‘á»ƒ xuáº¥t. HÃ£y táº¡o lá»‹ch trÆ°á»›c.");
    return;
  }

  // Láº¥y text tá»«ng Ã´ (Ä‘áº·c biá»‡t Ã´ ca cÃ³ <select>)
  const trs = [...table.querySelectorAll("tr")];
  const grid = trs.map(tr => {
    const cells = [...tr.querySelectorAll("th,td")];
    return cells.map(td => {
      const selects = [...td.querySelectorAll("select")];
      if(selects.length){
        return selects.map(s => s.value).join(" - ");
      }
      return td.innerText.trim().replace(/\s+/g," ");
    });
  });

  // Váº½ báº£ng lÃªn canvas
  const padding = 20;
  const rowH = 34;
  const headerH = 38;

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  // font (báº¡n cÃ³ thá»ƒ Ä‘á»•i)
  ctx.font = "14px Segoe UI, Arial";
  const cellPadX = 12;

  // TÃ­nh Ä‘á»™ rá»™ng tá»«ng cá»™t theo text dÃ i nháº¥t
  const cols = Math.max(...grid.map(r => r.length));
  const colW = Array(cols).fill(0);

  for(const row of grid){
    for(let c=0;c<cols;c++){
      const text = (row[c] ?? "");
      const w = ctx.measureText(text).width + cellPadX*2;
      colW[c] = Math.max(colW[c], Math.ceil(w));
    }
  }

  const width = padding*2 + colW.reduce((a,b)=>a+b,0);
  const height = padding*2 + (grid.length-1)*rowH + headerH;

  canvas.width = Math.ceil(width);
  canvas.height = Math.ceil(height);

  // Ná»n tráº¯ng
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Váº½ header ná»n xÃ¡m nháº¡t
  let x0 = padding, y0 = padding;
  ctx.fillStyle = "#f1f5f9";
  ctx.fillRect(x0, y0, colW.reduce((a,b)=>a+b,0), headerH);

  // Viá»n + chá»¯
  ctx.strokeStyle = "#94a3b8";
  ctx.fillStyle = "#0f172a";
  ctx.textBaseline = "middle";

  // Váº½ tá»«ng Ã´
  let y = y0;
  for(let r=0;r<grid.length;r++){
    const isHeader = (r===0);
    const h = isHeader ? headerH : rowH;

    let x = x0;
    for(let c=0;c<cols;c++){
      const w = colW[c];
      // khung Ã´
      ctx.strokeRect(x, y, w, h);

      // text
      const text = (grid[r][c] ?? "");
      ctx.fillStyle = isHeader ? "#0f172a" : "#111827";
      ctx.font = isHeader ? "bold 14px Segoe UI, Arial" : "14px Segoe UI, Arial";
      ctx.fillText(text, x + cellPadX, y + h/2);

      x += w;
    }
    y += h;
  }

  // Táº£i PNG
  canvas.toBlob(blob => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "lich_truc_nhat.png";
    a.click();
    URL.revokeObjectURL(a.href);
  }, "image/png");
}
function exportCSV(){
  if(!state.schedule.length) return;
  let csv="NgÃ y,Thá»©,Ca sÃ¡ng,Ca chiá»u\n";
  state.schedule.forEach(r=>{
    csv+=`${formatDMY(r.date)},${["CN","T2","T3","T4","T5","T6","T7"][r.date.getDay()]},"${r.morning.join(" - ")}","${r.afternoon.join(" - ")}"\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download="lich_truc_nhat.csv";
  a.click();
}
document.addEventListener("input", (e)=>{
  if(e.target && (e.target.id === "searchName")) renderTable();
});
document.addEventListener("change", (e)=>{
  if(e.target && (e.target.id === "searchDate")) renderTable();
});
document.addEventListener("DOMContentLoaded", () => {
  initProfiles();
  updateUndoRedoUI();
  initTheme();
});
function isoToDMY(iso){
  if(!iso) return "--/--/----";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}

function updateTimeDMY(){
  const s = document.getElementById("startDate");
  const e = document.getElementById("endDate");
  const sd = document.getElementById("startDateDMY");
  const ed = document.getElementById("endDateDMY");
  if(sd) sd.textContent = isoToDMY(s?.value);
  if(ed) ed.textContent = isoToDMY(e?.value);
}

document.getElementById("startDate")?.addEventListener("change", updateTimeDMY);
document.getElementById("endDate")?.addEventListener("change", updateTimeDMY);
document.addEventListener("DOMContentLoaded", updateTimeDMY);
function isoToDMY(iso){
  if(!iso) return "--/--/----";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}

function updateTimeDMY(){
  const s = document.getElementById("startDate");
  const e = document.getElementById("endDate");
  const sd = document.getElementById("startDateDMY");
  const ed = document.getElementById("endDateDMY");

  if(sd) sd.textContent = isoToDMY(s ? s.value : "");
  if(ed) ed.textContent = isoToDMY(e ? e.value : "");
}

// cáº­p nháº­t ngay khi chá»n ngÃ y
document.getElementById("startDate")?.addEventListener("change", updateTimeDMY);
document.getElementById("endDate")?.addEventListener("change", updateTimeDMY);

// cáº­p nháº­t ngay khi má»Ÿ trang (náº¿u input Ä‘Ã£ cÃ³ giÃ¡ trá»‹)
window.addEventListener("load", updateTimeDMY);
</script>

</body>
</html>

